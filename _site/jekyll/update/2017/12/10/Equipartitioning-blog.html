<!DOCTYPE html>
<html lang="en">
<script type="text/javascript" async 
src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?
config=TeX-AMS-MML_HTMLorMML"></script>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Equiparitioning</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/jekyll/update/2017/12/10/Equipartitioning-blog.html">
  <link rel="alternate" type="application/rss+xml" title="Michael Arnold" href="/feed.xml">
  
  
</head>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Michael Arnold</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
            <a class="page-link" href="/Examples/2017-12-10-welcome-to-jekyll.html">Welcome to Jekyll!</a>
            
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Equiparitioning</h1>
    <p class="post-meta">
      <time datetime="2017-12-10T15:46:30-05:00" itemprop="datePublished">
        
        Dec 10, 2017
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <script type="text/javascript" async="" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<h2 id="introduction">Introduction</h2>
<p>Recently, I’ve been working on this problem of optimal facility placement. Briefly stated, if we have a finite number of resources allowing us to place \(n\) facilities (hospitals, schools, or coffee shops), where should we put them to get maximum benefit, or maximum access. Formulated as an integral equation, we want</p>

<script type="math/tex; mode=display">f(\vec{r}_1 \dots \vec{r}_p) =\int_{A} \rho (\vec{r}) \min_{i \in \{ 1\dots p} \|\vec{r}-\vec{r}_i\| d^2\vec{r}</script>

<p>to be minimized. Here \(\vec{r}_1\) are the facility locations, \(\rho (\vec{r}) \) is the population density, and \(|\vec{r}-\vec{r}_i|\) is the distance from location r to the nearest facility.</p>

<p>Um et. al. reported an optimal facility placement which scales as a power law to the population density
\( D \sim \rho ^\alpha \)
For facilities that attempt to maximize profit \(\alpha = 1\)
, while systems that try to maximize facility access by minimizing average travel time, scale as 
\(\alpha = 2/3\).
This optimal scaling relects emperically observed facility placement. Certainly my introduction to this topic began with Um et al.</p>

<p>Prior to this empirical study, Gastner and Newman published a paper looking at this same facility placement problem. They had previously published a paper demonstrating the applicability of diffusion methods to create density equalizing cartograms, and now showed that these cartograms, and the diffusion method powering them, could be used to place facilities. Below is shown Gastner and Newman’s plot of 5000 facilities placed optimally, with the US diffused to equalize \(\rho^{2/3}\) on the right, and equalizing \(\rho\) on the left.</p>

<p><img src="http://localhost:4000/images/newman.png" alt="Newman" /></p>

<p>Of course this is an interesting result in its own respect, but our contribution is in recognizing that the class of problems that are solved by optimizing some integral function subject to a set of constraints, such as this k-medians problems, Highly Optimized Tolerance, or Elastic Net can be better understood through this connection to probability diffusion.</p>

<h2 id="generating-density-equalizing-projections-cart">Generating Density Equalizing Projections: Cart</h2>
<p>Newman and Gastner published a program for generating cartograms called cart, which given a discrete grid of density values, computes the final position of massless points after diffusion occurs, given initial positions in the density distribution.</p>

<p>By length, most of the C++ code is declaration of variables and allocation of memory, but I briefly go through the relevant computational method.</p>

<p>The code uses fourth-order Runge-Kutta to intergrate the diffusion equation forward in time, and uses two different step sizes to get an error bound, and to pick an adaptive step size.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cm">/* Do all three RK steps for each point in turn */</span>
  <span class="n">esqmax</span> <span class="o">=</span> <span class="n">drsqmax</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">npoints</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">rx1</span> <span class="o">=</span> <span class="n">pointx</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
    <span class="n">ry1</span> <span class="o">=</span> <span class="n">pointy</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>

    <span class="cm">/* Do the big combined (2h) RK step */</span>

    <span class="n">cart_velocity</span><span class="p">(</span><span class="n">rx1</span><span class="p">,</span><span class="n">ry1</span><span class="p">,</span><span class="n">s0</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v1x</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v1y</span><span class="p">);</span>
    <span class="n">k1x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v1x</span><span class="p">;</span>
    <span class="n">k1y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v1y</span><span class="p">;</span>
    <span class="n">cart_velocity</span><span class="p">(</span><span class="n">rx1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">k1x</span><span class="p">,</span><span class="n">ry1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">k1y</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v2x</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v2y</span><span class="p">);</span>
    <span class="n">k2x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v2x</span><span class="p">;</span>
    <span class="n">k2y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v2y</span><span class="p">;</span>
    <span class="n">cart_velocity</span><span class="p">(</span><span class="n">rx1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">k2x</span><span class="p">,</span><span class="n">ry1</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">k2y</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v3x</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v3y</span><span class="p">);</span>
    <span class="n">k3x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v3x</span><span class="p">;</span>
    <span class="n">k3y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v3y</span><span class="p">;</span>
    <span class="n">cart_velocity</span><span class="p">(</span><span class="n">rx1</span><span class="o">+</span><span class="n">k3x</span><span class="p">,</span><span class="n">ry1</span><span class="o">+</span><span class="n">k3y</span><span class="p">,</span><span class="n">s4</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v4x</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v4y</span><span class="p">);</span>
    <span class="n">k4x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v4x</span><span class="p">;</span>
    <span class="n">k4y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">v4y</span><span class="p">;</span>

    <span class="n">dx12</span> <span class="o">=</span> <span class="p">(</span><span class="n">k1x</span><span class="o">+</span><span class="n">k4x</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">k2x</span><span class="o">+</span><span class="n">k3x</span><span class="p">))</span><span class="o">/</span><span class="mf">6.0</span><span class="p">;</span>
    <span class="n">dy12</span> <span class="o">=</span> <span class="p">(</span><span class="n">k1y</span><span class="o">+</span><span class="n">k4y</span><span class="o">+</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">k2y</span><span class="o">+</span><span class="n">k3y</span><span class="p">))</span><span class="o">/</span><span class="mf">6.0</span><span class="p">;</span></code></pre></figure>

<p>Here we see the familiar integration scheme, where the new position of the points is integrated forward in time by an amount 2h multiplied by the velocity in the x and y directions. The velocities are dependent on local differences in density, which are computed the function cart_vgrid. The meat of the function lies in this loop, which steps through each interior point on the grid and computes the instantaneous velocity, based on the density of the points above below, to the left and right.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">for</span> <span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">ix</span><span class="o">&lt;</span> <span class="n">xsize</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">r01</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][(</span><span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ysize</span><span class="p">];</span>
    <span class="n">r11</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="o">*</span><span class="n">ysize</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">iy</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">iy</span><span class="o">&lt;</span> <span class="n">ysize</span><span class="p">;</span> <span class="n">iy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">r00</span> <span class="o">=</span> <span class="n">r01</span><span class="p">;</span>
      <span class="n">r10</span> <span class="o">=</span> <span class="n">r11</span><span class="p">;</span>
      <span class="n">r01</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][(</span><span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ysize</span><span class="o">+</span><span class="n">iy</span><span class="p">];</span>
      <span class="n">r11</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="o">*</span><span class="n">ysize</span><span class="o">+</span><span class="n">iy</span><span class="p">];</span>
      <span class="n">mid</span> <span class="o">=</span> <span class="n">r10</span> <span class="o">+</span> <span class="n">r00</span> <span class="o">+</span> <span class="n">r11</span> <span class="o">+</span> <span class="n">r01</span><span class="p">;</span>
      <span class="n">vxt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">r10</span><span class="o">-</span><span class="n">r00</span><span class="o">+</span><span class="n">r11</span><span class="o">-</span><span class="n">r01</span><span class="p">)</span><span class="o">/</span><span class="n">mid</span><span class="p">;</span>
      <span class="n">vyt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">r01</span><span class="o">-</span><span class="n">r00</span><span class="o">+</span><span class="n">r11</span><span class="o">-</span><span class="n">r10</span><span class="p">)</span><span class="o">/</span><span class="n">mid</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></figure>

<p>This function imposes hardwall boundary condition,shown partially below.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cm">/* Do the corners */</span>

  <span class="n">vxt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vyt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="n">vxt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">xsize</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vyt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">xsize</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="n">vxt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">ysize</span><span class="p">]</span> <span class="o">=</span> <span class="n">vyt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">ysize</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="n">vxt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">xsize</span><span class="p">][</span><span class="n">ysize</span><span class="p">]</span> <span class="o">=</span> <span class="n">vyt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">xsize</span><span class="p">][</span><span class="n">ysize</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

  <span class="cm">/* Do the top border */</span>

  <span class="n">r11</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">ix</span><span class="o">&lt;</span> <span class="n">xsize</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">r01</span> <span class="o">=</span> <span class="n">r11</span><span class="p">;</span>
    <span class="n">r11</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="o">*</span><span class="n">ysize</span><span class="p">];</span>
    <span class="n">vxt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">r11</span><span class="o">-</span><span class="n">r01</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">r11</span><span class="o">+</span><span class="n">r01</span><span class="p">);</span>
    <span class="n">vyt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Do the bottom border */</span>

  <span class="n">r10</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ysize</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">ix</span><span class="o">&lt;</span><span class="n">xsize</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">r00</span> <span class="o">=</span> <span class="n">r10</span><span class="p">;</span>
    <span class="n">r10</span> <span class="o">=</span> <span class="n">rhot</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="o">*</span><span class="n">ysize</span><span class="o">+</span><span class="n">ysize</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">vxt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">ysize</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">r10</span><span class="o">-</span><span class="n">r00</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">r10</span><span class="o">+</span><span class="n">r00</span><span class="p">);</span>
    <span class="n">vyt</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">ysize</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="p">}</span></code></pre></figure>

<p>Then arbitary points velocity are computed using a bilinear interpolation from this grid.</p>

<p>A nearly identical step integrates forward the same initial position with two smaller h sized Runge Kutta steps.</p>

<p>The error is estimated by finding the distance between the one big step, and two smaller steps.</p>

<p>This function is dropped into a do loop, which terminates when the target error is achieved.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">t</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">blur</span><span class="o">*</span><span class="n">blur</span><span class="p">;</span>
  <span class="n">h</span> <span class="o">=</span> <span class="n">INITH</span><span class="p">;</span>

  <span class="k">do</span> <span class="p">{</span>

    <span class="cm">/* Do a combined (triple) integration step */</span>

    <span class="n">cart_twosteps</span><span class="p">(</span><span class="n">pointx</span><span class="p">,</span><span class="n">pointy</span><span class="p">,</span><span class="n">npoints</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">xsize</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>

    <span class="cm">/* Increase the time by 2h and rotate snapshots */</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">h</span><span class="p">;</span>
    <span class="n">step</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>

    <span class="cm">/* Adjust the time-step.  Factor of 2 arises because the target for
     * the two-step process is twice the target for an individual step */</span>

    <span class="n">desiredratio</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">TARGETERROR</span><span class="o">/</span><span class="n">error</span><span class="p">,</span><span class="mf">0.2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">desiredratio</span><span class="o">&gt;</span><span class="n">MAXRATIO</span><span class="p">)</span> <span class="n">h</span> <span class="o">*=</span> <span class="n">MAXRATIO</span><span class="p">;</span>
    <span class="k">else</span> <span class="n">h</span> <span class="o">*=</span> <span class="n">desiredratio</span><span class="p">;</span>

    <span class="n">done</span> <span class="o">=</span> <span class="n">cart_complete</span><span class="p">(</span><span class="n">t</span><span class="p">);</span></code></pre></figure>

<p>Diffusion of points is achieved by running given initial points through another script, “interp,” which maps them forward to the steady state. This is done with a shell script such as</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="nb">cat</span> /Users/Winston/Dropbox/Equipartition/cart-1.2.2/exp2.dat | ./interp 512 512 expout.dat <span class="o">&gt;</span> /Users/Winston/Dropbox/Equipartition/cart-1.2.2/expout2.dat</code></pre></figure>

<p>although if a pair of points is typed into the termial after initializing interp it will output the diffused xy pair.</p>

<h2 id="generating-arbiratry-probability-densities-for-cart">Generating Arbiratry Probability Densities for Cart</h2>

<p>Adapting Cart for my own uses involved writing a script to generate my probability distributions and formatting them for cart do the heavy lifting. The probability distributions were generated and normalized then stretched to be discretized by the function generate_dist.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">generate_dist</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dist_type</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">dist_type</span> <span class="o">==</span> <span class="s">'exp'</span><span class="p">:</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">expon</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">dimx</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pixel_gap</span><span class="p">)</span><span class="o">+</span><span class="n">pixel_gap</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">expon</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">*=</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">dimy</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pixel_gap</span><span class="p">)</span><span class="o">+</span><span class="n">pixel_gap</span>
		<span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
	<span class="c">## add distribution types</span>
	<span class="k">elif</span> <span class="n">dist_type</span> <span class="o">==</span> <span class="s">"gaussian"</span><span class="p">:</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
		<span class="n">x</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">dimx</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pixel_gap</span><span class="p">)</span><span class="o">+</span><span class="n">pixel_gap</span>		
		<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
		<span class="n">y</span> <span class="o">*=</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">dimy</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pixel_gap</span><span class="p">)</span><span class="o">+</span><span class="n">pixel_gap</span>
		<span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="s">"Error: distribution not recognized"</span><span class="p">)</span></code></pre></figure>

<p>After we have a random sample drawn from some specified probability distribution, the script saves these xy points to file for plotting, and finds the discretized density using the function find_density, which just bins the data, and finds the average density.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">find_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dimx</span><span class="p">,</span><span class="n">dimy</span><span class="p">,</span><span class="n">pixel_gap</span><span class="p">):</span>
	<span class="s">'''finds spatial density in grid'''</span>
	<span class="n">nx</span><span class="p">,</span><span class="n">ny</span> <span class="o">=</span> <span class="n">dimx</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pixel_gap</span><span class="p">),</span><span class="n">dimy</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pixel_gap</span><span class="p">)</span> <span class="c"># change to be number of pixels</span>
	<span class="n">H</span><span class="p">,</span><span class="n">xedges</span><span class="p">,</span><span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
	<span class="n">ave_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">H</span><span class="p">,</span><span class="n">xedges</span><span class="p">,</span><span class="n">yedges</span><span class="p">,</span><span class="n">ave_density</span></code></pre></figure>

<p>Last we create an array to surround this binned density data with a sea of the average density, and save the array to be the input of cart.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">generate_array</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">xedges</span><span class="p">,</span><span class="n">yedges</span><span class="p">,</span><span class="n">dimx</span><span class="p">,</span><span class="n">dimy</span><span class="p">,</span><span class="n">pixel_gap</span><span class="p">,</span><span class="n">ave_density</span><span class="p">):</span>
	<span class="s">'''make array of data in correct dimensions to feed to cart.c'''</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">dimx</span><span class="p">,</span><span class="n">dimy</span><span class="p">])</span>
	<span class="n">data</span> <span class="o">*=</span> <span class="n">ave_density</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">pixel_gap</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">pixel_gap</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
	<span class="k">return</span> <span class="n">data</span></code></pre></figure>

<p>Below is a plot of the array for a gaussian distribution, just to give an idea.
<img src="http://localhost:4000/images/array.png" alt="Array" /></p>

<p>Cart takes this array, allows the density to diffuse, and then calculates the velocity feild to see to where massless particles would diffuse.</p>

<p>Here is a copy of <a href="http://localhost:4000/assets/dist_gen1.py">dist_gen.py</a>  for your perusal.</p>

<h2 id="results">Results</h2>
<p>Shown below are the current iteration of figures for this project. The first figure shows on the left 100000 points drawn from both a 2-d exponential and gaussian distribution, color coded by their parition into 50 optimally distributed cells, where the placement of the cells minimizes average distance to the closest cell center. Below is a histogram of the density of the distribution.</p>

<p>On the right are the same 100000 xy points, after being diffused by cart, still color coded by voronoi cells. Clearly the density is more uniform than before, looking at the xy points themselves, the concentration of black voronoi cell centers, or the histogram below, which is computed be taking a sampling inside the thin black rectangle.<br />
<img src="http://localhost:4000/images/2.png" alt="50 Partions" /></p>

<p>The second figure just demonstrates that the code works for an arbitrary  number of partitions, in this case 500. You can see near the top edge of this image, that the density is still noticably non-uniform. This is likely due to the course grained binning that occurs, and that the transition from zero density in the top right corner to average density just outside the 512x512 array of interest is instantaneous. Of course it is also true that this k-medians method distributes facilities \(D\sim \rho^{2/3}\) so we should expect that regions with a lower population density prior to diffusion will be regions of higher facility density on a population density equalized cartogram.
<img src="http://localhost:4000/images/500.png" alt="500 Partions" />
The code used to generate these images is <a href="http://localhost:4000/assets/Equipartitioning.ipynb">Equipartitioning</a>, though you should be warned its path depence hasn’t been designed with other machines in mind, and I haven’t added my implementation of k-medians to the scipy.cluster.vq repository yet.</p>

<p>The k-medians implimentation and the dynamic shell script creation all takes place inside this jupyter notebook.</p>


  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Michael Arnold</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Michael Arnold
            
            </li>
            
            <li><a href="mailto:mvarnold@uvm.edu">mvarnold@uvm.edu</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mvarnold"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mvarnold</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/WinstonAtlasA"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">WinstonAtlasA</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
